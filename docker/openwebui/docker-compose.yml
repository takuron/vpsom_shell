version: "3.8"

services:
  # --- OpenWebUI 服务 ---
  # 官方镜像: https://github.com/open-webui/open-webui
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    volumes:
      # 挂载数据卷，用于持久化存储用户、设置和聊天记录
      - openwebui_data:/app/backend/data
    ports:
      # 关键：只暴露端口到主机的 127.0.0.1 (localhost)
      # 这样公网无法直接访问，只能通过您在主机上的 Caddy 访问
      - "127.0.0.1:28193:8080" # 映射容器8080到主机的28193端口
    environment:
      # 关键：设置为空，以禁用启动时对 Ollama 后端的强制连接检查
      # 这允许您启动后在 Web 界面中自由配置任何 OpenAI 格式的 API
      # - 'OLLAMA_API_BASE_URL=""'
      # - 'OLLAMA_BASE_URL=""' # 较新版本可能使用这个，两个都加上更保险
      - 'TZ=Asia/Shanghai'    # 设置时区
    restart: unless-stopped
    healthcheck:
      # 健康检查：尝试访问容器内的 /health 接口
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s    # 每30秒检查一次
      timeout: 10s     # 10秒超时
      retries: 3       # 失败重试3次
      start_period: 60s # 启动后等待60秒再开始第一次检查
    labels:
      # --- 自动更新标签 ---
      # 为 Watchtower 启用自动更新
      - "com.centurylinklabs.watchtower.enable=true"

  # --- 自动更新服务 ---
  # https://containrrr.dev/watchtower/
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower_openwebui
    volumes:
      # 挂载 Docker socket 以便 Watchtower 可以管理其他容器
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - 'TZ=Asia/Shanghai'
    command: >
      --schedule "0 0 4 * * *"  # 每天凌晨4点检查更新
      --cleanup                 # 更新后自动删除旧镜像
      --label-enable            # 关键：只更新带有 "com.centurylinklabs.watchtower.enable=true" 标签的容器
    restart: unless-stopped
    labels:
      # 让 Watchtower 也自动更新它自己
      - "com.centurylinklabs.watchtower.enable=true"

# --- 数据卷定义 ---
volumes:
  openwebui_data:
    driver: local